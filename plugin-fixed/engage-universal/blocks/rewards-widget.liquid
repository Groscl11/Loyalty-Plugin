{% comment %}
  Engage Universal - Rewards Widget
  Shopify Theme App Extension Block
  Can be added to any page via Theme Editor
{% endcomment %}

<div
  id="rewardhub-widget-{{ block.id }}"
  class="rewardhub-widget"
  data-widget-id="{{ block.settings.widget_id }}"
  data-position="{{ block.settings.position }}"
  data-mobile="{{ block.settings.show_on_mobile }}"
  data-auto-open="{{ block.settings.auto_open }}"
  data-block-id="{{ block.id }}"
>
  <!-- Widget will be rendered here by JavaScript -->
</div>

<style>
  .rewardhub-widget {
    position: fixed;
    z-index: 9999;
  }

  .rewardhub-widget[data-position="bottom-right"] {
    bottom: 20px;
    right: 20px;
  }

  .rewardhub-widget[data-position="bottom-left"] {
    bottom: 20px;
    left: 20px;
  }

  .rewardhub-widget[data-position="top-right"] {
    top: 20px;
    right: 20px;
  }

  .rewardhub-widget[data-position="top-left"] {
    top: 20px;
    left: 20px;
  }

  @media (max-width: 768px) {
    .rewardhub-widget[data-mobile="false"] {
      display: none !important;
    }
  }

  /* Widget Button */
  .rewardhub-widget-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
  }

  .rewardhub-widget-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }

  .rewardhub-widget-button svg {
    width: 30px;
    height: 30px;
    fill: white;
  }

  .rewardhub-widget-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
  }

  /* Widget Panel */
  .rewardhub-widget-panel {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    width: 380px;
    max-width: calc(100vw - 40px);
    max-height: calc(100vh - 100px);
    overflow: hidden;
    display: none;
    flex-direction: column;
  }

  .rewardhub-widget-panel.active {
    display: flex;
  }

  .rewardhub-widget-panel[data-position="bottom-right"],
  .rewardhub-widget-panel[data-position="top-right"] {
    bottom: 90px;
    right: 20px;
  }

  .rewardhub-widget-panel[data-position="bottom-left"],
  .rewardhub-widget-panel[data-position="top-left"] {
    bottom: 90px;
    left: 20px;
  }

  .rewardhub-widget-panel[data-position="top-right"],
  .rewardhub-widget-panel[data-position="top-left"] {
    bottom: auto;
    top: 90px;
  }

  /* Widget Header */
  .rewardhub-widget-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rewardhub-widget-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }

  .rewardhub-widget-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .rewardhub-widget-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Widget Content */
  .rewardhub-widget-content {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }

  .rewardhub-widget-loading {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
  }

  .rewardhub-widget-error {
    text-align: center;
    padding: 40px 20px;
    color: #ef4444;
  }

  /* Reward Card */
  .rewardhub-reward-card {
    background: #f9fafb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
  }

  .rewardhub-reward-card h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #111827;
  }

  .rewardhub-reward-card p {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #6b7280;
  }

  .rewardhub-reward-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    width: 100%;
    transition: opacity 0.2s;
  }

  .rewardhub-reward-button:hover {
    opacity: 0.9;
  }
</style>

<script>
  (function() {
    const SUPABASE_URL = 'https://lizgppzyyljqbmzdytia.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpemdwcHp5eWxqcWJtemR5dGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MDE0MDYsImV4cCI6MjA3OTk3NzQwNn0.E5yJHY4mjOvLiqZCfCp9vnNC7xsRAlBSdW55YE2RPC0';

    // Initialize widget
    function initRewardHubWidget(container) {
      const widgetId = container.dataset.widgetId;
      const position = container.dataset.position;
      const autoOpen = container.dataset.autoOpen === 'true';

      if (!widgetId) {
        console.error('Loyalty by Goself: Widget ID is required');
        return;
      }

      // Create widget structure
      const button = createWidgetButton();
      const panel = createWidgetPanel(position);

      container.appendChild(button);
      container.appendChild(panel);

      // Load widget configuration
      loadWidgetConfig(widgetId, panel, button);

      // Button click handler
      button.addEventListener('click', function() {
        panel.classList.toggle('active');
      });

      // Close button handler
      const closeBtn = panel.querySelector('.rewardhub-widget-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          panel.classList.remove('active');
        });
      }

      // Auto open if configured
      if (autoOpen) {
        setTimeout(() => {
          panel.classList.add('active');
        }, 2000);
      }
    }

    // Create widget button
    function createWidgetButton() {
      const button = document.createElement('button');
      button.className = 'rewardhub-widget-button';
      button.innerHTML = `
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
        </svg>
        <span class="rewardhub-widget-badge" style="display: none;">0</span>
      `;
      return button;
    }

    // Create widget panel
    function createWidgetPanel(position) {
      const panel = document.createElement('div');
      panel.className = 'rewardhub-widget-panel';
      panel.dataset.position = position;
      panel.innerHTML = `
        <div class="rewardhub-widget-header">
          <h3>Your Rewards</h3>
          <button class="rewardhub-widget-close">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 6.585l4.293-4.292a1 1 0 111.414 1.414L9.415 8l4.292 4.293a1 1 0 01-1.414 1.414L8 9.415l-4.293 4.292a1 1 0 01-1.414-1.414L6.585 8 2.293 3.707a1 1 0 011.414-1.414L8 6.585z"/>
            </svg>
          </button>
        </div>
        <div class="rewardhub-widget-content">
          <div class="rewardhub-widget-loading">Loading rewards...</div>
        </div>
      `;
      return panel;
    }

    // Load widget configuration
    async function loadWidgetConfig(widgetId, panel, button) {
      const content = panel.querySelector('.rewardhub-widget-content');

      try {
        // Get shop domain
        const shopDomain = window.Shopify?.shop || window.location.hostname;

        // Fetch widget config
        const response = await fetch(`${SUPABASE_URL}/functions/v1/get-widget-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            widget_id: widgetId,
            shop_domain: shopDomain
          })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load widget');
        }

        // Check if customer has rewards
        await loadCustomerRewards(widgetId, content, button, data.config);

      } catch (error) {
        console.error('RewardHub error:', error);
        content.innerHTML = `
          <div class="rewardhub-widget-error">
            <p>Unable to load rewards</p>
            <p style="font-size: 12px;">${error.message}</p>
          </div>
        `;
      }
    }

    // Load customer rewards
    async function loadCustomerRewards(widgetId, content, button, config) {
      try {
        // Get customer email if logged in
        const customerEmail = window.Shopify?.customerEmail || null;

        if (!customerEmail) {
          content.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
              <p style="color: #6b7280; margin-bottom: 16px;">Sign in to view your rewards</p>
              <a href="/account/login" style="
                display: inline-block;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
              ">Sign In</a>
            </div>
          `;
          return;
        }

        // Fetch customer rewards (you'll need to create this edge function)
        const response = await fetch(`${SUPABASE_URL}/functions/v1/get-customer-rewards`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({
            customer_email: customerEmail,
            widget_id: widgetId
          })
        });

        const data = await response.json();

        if (data.rewards && data.rewards.length > 0) {
          // Update badge
          const badge = button.querySelector('.rewardhub-widget-badge');
          if (badge) {
            badge.textContent = data.rewards.length;
            badge.style.display = 'flex';
          }

          // Render rewards
          renderRewards(content, data.rewards);
        } else {
          content.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
              <p style="color: #6b7280;">No rewards available yet</p>
              <p style="font-size: 14px; color: #9ca3af; margin-top: 8px;">Keep shopping to earn rewards!</p>
            </div>
          `;
        }

      } catch (error) {
        console.error('Failed to load rewards:', error);
        content.innerHTML = `
          <div class="rewardhub-widget-error">
            <p>Unable to load your rewards</p>
          </div>
        `;
      }
    }

    // Render rewards
    function renderRewards(content, rewards) {
      content.innerHTML = rewards.map(reward => `
        <div class="rewardhub-reward-card">
          <h4>${escapeHtml(reward.name)}</h4>
          <p>${escapeHtml(reward.description || '')}</p>
          ${reward.redemption_link ? `
            <button
              class="rewardhub-reward-button"
              onclick="window.open('${escapeHtml(reward.redemption_link)}', '_blank')"
            >
              Claim Reward
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize all widgets on page
    document.addEventListener('DOMContentLoaded', function() {
      const widgets = document.querySelectorAll('.rewardhub-widget');
      widgets.forEach(widget => initRewardHubWidget(widget));
    });

    // Re-initialize for dynamic content (Shopify sections)
    if (typeof MutationObserver !== 'undefined') {
      const observer = new MutationObserver(function(mutations) {
        const widgets = document.querySelectorAll('.rewardhub-widget:not([data-initialized])');
        widgets.forEach(widget => {
          widget.dataset.initialized = 'true';
          initRewardHubWidget(widget);
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Rewards Widget",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "widget_id",
      "label": "Loyalty by Goself Widget ID",
      "info": "Enter the widget ID from your Goself dashboard (https://goself.netlify.app)"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Widget Position",
      "options": [
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "top-right",
          "label": "Top Right"
        },
        {
          "value": "top-left",
          "label": "Top Left"
        }
      ],
      "default": "bottom-right"
    },
    {
      "type": "checkbox",
      "id": "show_on_mobile",
      "label": "Show on Mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "auto_open",
      "label": "Auto Open on Page Load",
      "default": false
    }
  ]
}
{% endschema %}
